<!DOCTYPE html>
<html>
	<head>
		<title>Login Users</title>
		<link rel="stylesheet" href="style.css">
	</head>
	<body data-server-no-reload>
		<form id="add-user">
			<label for="input-email">Email: </label>
			<input type="email" id="input-email" name="email" placeholder="example@gmail.com" required>
			<p />
			<label for="input-password">Password: </label>
			<input type="password" id="input-password" name="password" placeholder="password" required>
			<p />
			<input type="submit" value="Signin!">
			<div id="result">
				<script>
					const API_URI = "http://localhost:8080";

					async function handleLoginForm(event) {
						event.preventDefault();

						const email = document.getElementById('input-email').value.trim();
						const password = document.getElementById('input-password').value.trim();
						const resultDiv = document.getElementById('result');
						resultDiv.innerHTML = '';

						const requestBody = {
							email: email,
							password: password
						};

						const endpoint = `${API_URI}/users/signin`;

						try {
							const response = await fetch(endpoint, {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
								},
								body: JSON.stringify(requestBody)
							});

							// Leggi SEMPRE il corpo della risposta, anche in caso di errore HTTP
							let data;
							try {
								data = await response.json();
							} catch (parseError) {
								// Se il corpo non Ã¨ JSON valido, usa un oggetto vuoto
								data = {};
							}

							if (response.ok) {
								// Login riuscito
								localStorage.setItem('sessionId', data.id);
								window.location.href = "./index.html";
							} else {
								// Login fallito: mostra il payload signinUser se presente
								if (data.signinUser !== undefined) {
									resultDiv.innerHTML = `<p>Errore: ${JSON.stringify(data.signinUser)}</p>`;
								} else if (data.message) {
									resultDiv.innerHTML = `<p>Errore: ${data.message}</p>`;
								} else {
									resultDiv.innerHTML = `<p>Errore: credenziali non valide o server non raggiungibile.</p>`;
								}
							}
						} catch (error) {
							console.error("Errore durante la richiesta:", error);
							resultDiv.innerHTML = `<p>Errore di rete: impossibile contattare il server.</p>`;
						}
					}

					window.onload = init;

					async function init() {
						const form = document.getElementById('add-user');
						form.addEventListener('submit', handleLoginForm);
					}
				</script>
				
			</div>
		</form>
		
	</body>
</html>